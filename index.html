<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ä¸­æ–‡æ•™å­¸å±•ç¤º</title>
  <style>
    /* ç¹é«”ä¸­æ–‡å­—é«”å †ç–Š - å„ªå…ˆä½¿ç”¨ç¹é«”å­—é«” */
    @font-face {
      font-family: 'TraditionalChinese';
      unicode-range: U+4E00-9FFF, U+3400-4DBF, U+20000-2A6DF, U+2A700-2B73F, U+2B740-2B81F, U+2B820-2CEAF;
    }
    
    body {
      margin: 0;
      /* ç¹é«”ä¸­æ–‡å­—é«”å„ªå…ˆé †åºï¼šç³»çµ±ç¹é«”å­—é«” > é€šç”¨ä¸­æ–‡å­—é«” > å‚™ç”¨å­—é«” */
      font-family: 
        "PingFang TC", "Microsoft JhengHei", "Microsoft YaHei", 
        "Heiti TC", "STHeiti", "LiHei Pro", "LiSong Pro", 
        "BiauKai", "KaiTi", "DFKai-SB", "æ¨™æ¥·é«”", "æ–°ç´°æ˜é«”",
        "Comic Sans MS", sans-serif;
      background-color: #fff8f0;
      text-align: center;
      overflow-x: hidden;
      /* ç¢ºä¿ç¹é«”ä¸­æ–‡æ­£ç¢ºæ¸²æŸ“ */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* é‡å°ä¸­æ–‡å­—ç¬¦ç‰¹åˆ¥æŒ‡å®šå­—é«” */
    .sentence, .char {
      font-family: 
        "PingFang TC", "Microsoft JhengHei", "Microsoft YaHei", 
        "Heiti TC", "STHeiti", "LiHei Pro", "LiSong Pro", 
        "BiauKai", "KaiTi", "DFKai-SB", "æ¨™æ¥·é«”", "æ–°ç´°æ˜é«”",
        "Comic Sans MS", sans-serif;
      /* ä½¿ç”¨ç¹é«”ä¸­æ–‡æ¸²æŸ“ */
      font-feature-settings: "kern" 1, "liga" 1;
    }
    select {
      margin-top: 1rem;
      font-size: 1.2rem;
      padding: 0.5rem;
      border-radius: 8px;
    }
    .sentence {
      font-size: 2.5rem;
      margin-top: 2rem;
    }
    .char {
      margin: 0 0.3em;
      display: inline-block;
      padding: 0.2em 0.4em;
      border-radius: 10px;
      background: #eee;
      box-shadow: 2px 2px 5px #ccc;
      transition: transform 0.2s;
      position: relative;
    }
    .char.has-img {
      background: #ffefd5;
      cursor: pointer;
    }
    .char.preview-only {
      background: #eee;
    }
    .char.no-stroke {
      background: #ddd;
    }
    .char.has-img img.preview {
      display: block;
      width: 40px;
      height: auto;
      margin: 0 auto;
    }
    .char:active {
      transform: scale(1.2);
    }
    .controls {
      margin-top: 2rem;
    }
    button {
      font-size: 1.2rem;
      margin: 0.5rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      background-color: #ffb6c1;
      color: white;
      box-shadow: 2px 2px 5px #999;
    }
    #fullscreen-view {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1000;
      /* é˜²æ­¢èƒŒæ™¯æ»¾å‹• */
      touch-action: none;
      -webkit-overflow-scrolling: touch;
    }
    #fullscreen-img {
      width: auto;
      height: auto;
      max-width: 95vw;
      max-height: 95vh;
      object-fit: contain;
      /* å¹³æ»‘éæ¸¡æ•ˆæœ */
      transition: opacity 0.3s ease;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    /* åœ–ç‰‡è¼‰å…¥æŒ‡ç¤ºå™¨ */
    #fullscreen-img.loading {
      opacity: 0.5;
    }
    /* é—œé–‰æŒ‰éˆ• */
    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    /* åœ–ç‰‡ç´¢å¼•æŒ‡ç¤ºå™¨ */
    .image-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 1rem;
    }
    .sentence-index {
      font-size: 1.2rem;
      color: #888;
      margin-top: 0.5rem;
    }
    .end-indicator {
      font-size: 1.5rem;
      color: #888;
      margin-top: 1rem;
    }
    .char.has-stroke {
  background: #fffacd; /* æ·¡é»ƒè‰²ä»£è¡¨æœ‰ç­†é †åœ– */
}
  </style>
  <script src="strokeMap.js?v=20250203"></script>
  <script>
    // æª¢æŸ¥ strokeMap æ˜¯å¦æ­£ç¢ºè¼‰å…¥
    window.addEventListener('load', () => {
      if (typeof strokeMap === 'undefined') {
        console.error('âŒ strokeMap.js æ²’æœ‰æ­£ç¢ºè¼‰å…¥ï¼');
        alert('è­¦å‘Šï¼šç­†é †åœ–è³‡æ–™æ²’æœ‰æ­£ç¢ºè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æ¸…é™¤ç€è¦½å™¨å¿«å–');
      } else {
        const totalChars = Object.keys(strokeMap).length;
        console.log(`âœ… strokeMap å·²è¼‰å…¥ï¼Œå…±æœ‰ ${totalChars} å€‹å­—`);
        
        // æª¢æŸ¥ç‰¹å®šå­—æ˜¯å¦å­˜åœ¨ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
        const testChars = ['èƒ–', 'å¾€', 'å¤±', 'åŒ–', 'è™¹', 'é£Ÿ'];
        const missing = testChars.filter(char => !strokeMap.hasOwnProperty(char));
        if (missing.length > 0) {
          console.warn(`âš ï¸  ä»¥ä¸‹å­—æ²’æœ‰åœ¨ strokeMap ä¸­: ${missing.join(', ')}`);
          console.warn('é€™å¯èƒ½æ˜¯ç€è¦½å™¨å¿«å–å•é¡Œï¼Œè«‹æ¸…é™¤å¿«å–å¾Œé‡æ–°è¼‰å…¥');
        } else {
          console.log('âœ… æ¸¬è©¦å­—ï¼ˆèƒ–ã€å¾€ã€å¤±ã€åŒ–ã€è™¹ã€é£Ÿï¼‰éƒ½åœ¨ strokeMap ä¸­');
        }
        
        // å¦‚æœå­—æ•¸å°‘æ–¼é æœŸï¼Œå¯èƒ½æ˜¯èˆŠç‰ˆæœ¬
        if (totalChars < 650) {
          console.warn(`âš ï¸  strokeMap å­—æ•¸è¼ƒå°‘ï¼ˆ${totalChars}ï¼‰ï¼Œå¯èƒ½æ˜¯èˆŠç‰ˆæœ¬ï¼Œå»ºè­°æ¸…é™¤å¿«å–`);
        }
      }
    });
  </script>
</head>
<body>
  <select id="sheet-select" onchange="loadSheet()">
    <option value="https://docs.google.com/spreadsheets/d/13w2nNN8W5Xy7kcS_sLyhT0V4FLxbAF9A9q0idiGgnM0/export?format=csv">å—ä¸€åœ‹èªä¸€ä¸Š</option>
    <option value="https://docs.google.com/spreadsheets/d/16I3XgeJLkoNGgQ2WNirkOnNMB_7XzUkt5ZgQkalnXUA/export?format=csv">ç”Ÿæ´»è¯èª1</option>
    <option value="https://docs.google.com/spreadsheets/d/16rrma_hRQGhR2U-UNKHvPbSCl2PFREaKhpGEW4IWWNs/export?format=csv">ç”Ÿæ´»è¯èª2</option>
    <option value="https://docs.google.com/spreadsheets/d/18VNo2yeCM9x_IVds85WkIV2ueyKc-IAj60UNvOglGxM/export?format=csv">èªå­—</option>
  </select>
  <select id="lesson-select" onchange="changeLesson()"></select>

  <div class="sentence-index" id="sentence-index"></div>
  <div class="sentence" id="sentence"></div>
  <div class="end-indicator" id="end-indicator"></div>

  <div class="controls">
    <button onclick="prevSentence()">â¬…ï¸ ä¸Šä¸€å¥</button>
    <button onclick="playAudio()">ğŸ”Š æ’­æ”¾èªéŸ³</button>
    <button onclick="nextSentence()">â¡ï¸ ä¸‹ä¸€å¥</button>
    <button onclick="goToFirst()">ğŸ” å›åˆ°ç¬¬ä¸€å¥</button>
  </div>

  <div id="fullscreen-view">
    <button class="close-btn" onclick="closeFullscreen()" aria-label="é—œé–‰">âœ•</button>
    <img id="fullscreen-img" src="" alt="" />
    <div class="image-counter" id="image-counter"></div>
  </div>

  <script>
    let allLessons = {};
    let lessonTitles = [];
    let sentences = [];
    let current = 0;
    let sequence = [];
    let currentIndex = 0;
    // åœ–ç‰‡é è¼‰å¿«å–
    let imageCache = new Map();
    let preloadPromises = [];

    const sheetSelect = document.getElementById("sheet-select");
    const lessonSelect = document.getElementById("lesson-select");
    const sentenceContainer = document.getElementById("sentence");
    const sentenceIndexContainer = document.getElementById("sentence-index");
    const endIndicator = document.getElementById("end-indicator");
    const fullscreenView = document.getElementById("fullscreen-view");
    const fullscreenImg = document.getElementById("fullscreen-img");

    function loadSheet() {
      const url = sheetSelect.value;
      fetch(url)
        .then(response => response.text())
        .then(csv => {
          const lines = csv.split(/\r?\n/).map(line => line.trim());
          allLessons = {};
          const headers = lines[0].split(',');
          for (let col = 0; col < headers.length; col++) {
            const title = headers[col];
            const content = [];
            for (let row = 1; row < lines.length; row++) {
              const cells = lines[row].split(',');
              if (cells[col]) content.push(cells[col]);
            }
            if (title) allLessons[title] = content;
          }
          populateLessons();
        });
    }

    function populateLessons() {
      lessonSelect.innerHTML = '';
      lessonTitles = Object.keys(allLessons);
      lessonTitles.forEach((title, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = title;
        lessonSelect.appendChild(option);
      });
      changeLesson();
    }

    function changeLesson() {
      const index = lessonSelect.value;
      const title = lessonTitles[index];
      sentences = allLessons[title];
      current = 0;
      renderSentence();
    }

    function renderSentence() {
      const sentence = sentences[current];
      sentenceContainer.innerHTML = '';
      sentenceIndexContainer.textContent = `ç¬¬ ${current + 1} å¥ / å…± ${sentences.length} å¥`;
      endIndicator.textContent = (current === sentences.length - 1) ? 'ğŸ“š èª²æ–‡å·²ç¶“çµæŸ' : '';
      if (!sentence) return;
      for (const char of sentence) {
        const span = document.createElement("span");
        span.textContent = char;
        span.className = "char";

        if (strokeMap.hasOwnProperty(char)) {
         span.classList.add("has-stroke");
        } else {
         span.classList.add("no-stroke");
        }
        const imgPath = `${char}1.JPEG`;
        const img = new Image();
        img.src = imgPath;
img.onload = () => {
  span.classList.add("has-img");
  const preview = document.createElement("img");
  preview.src = imgPath;
  preview.className = "preview";
  span.appendChild(preview);
};
img.onerror = () => {
  // å³ä½¿æ²’æœ‰ JPEG ä¹Ÿå…è¨±é»æ“Šï¼Œé€²å…¥ç­†é †åœ–
};

span.onclick = () => showImageSequence(char);  // ç¸½æ˜¯è¨­ç½®é»æ“Šäº‹ä»¶


        sentenceContainer.appendChild(span);
      }
    }

    // é è¼‰å–®å¼µåœ–ç‰‡
    function preloadImage(src) {
      // å¦‚æœå·²ç¶“åœ¨å¿«å–ä¸­ï¼Œç›´æ¥è¿”å›å·²è§£æ±ºçš„ Promise
      if (imageCache.has(src)) {
        return Promise.resolve(imageCache.get(src));
      }
      
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          imageCache.set(src, img);
          resolve(img);
        };
        img.onerror = () => {
          // å³ä½¿è¼‰å…¥å¤±æ•—ä¹Ÿå¿«å–ï¼Œé¿å…é‡è¤‡å˜—è©¦
          imageCache.set(src, null);
          reject(new Error(`Failed to load: ${src}`));
        };
        img.src = src;
      });
    }

    // é è¼‰æ‰€æœ‰åœ–ç‰‡
    function preloadAllImages() {
      preloadPromises = [];
      const imageCounter = document.getElementById("image-counter");
      
      sequence.forEach((src, index) => {
        const promise = preloadImage(src).catch(() => {
          // å¿½ç•¥è¼‰å…¥å¤±æ•—çš„åœ–ç‰‡ï¼Œç¹¼çºŒè¼‰å…¥å…¶ä»–åœ–ç‰‡
        });
        preloadPromises.push(promise);
        
        // æ›´æ–°è¼‰å…¥é€²åº¦ï¼ˆå¯é¸ï¼Œå¦‚æœéœ€è¦é¡¯ç¤ºé€²åº¦ï¼‰
        promise.then(() => {
          const loaded = preloadPromises.filter(p => p.status === 'resolved' || 
            (p instanceof Promise && p._resolved)).length;
          // å¯ä»¥é¸æ“‡é¡¯ç¤ºé€²åº¦ï¼Œä½†ç‚ºäº†ä¸å¹²æ“¾é«”é©—ï¼Œé€™è£¡å…ˆä¸é¡¯ç¤º
        });
      });
    }

    function showImageSequence(char) {
      const sentence = sentences[current];
      sequence = [];
      for (const c of sentence) {
        if (!/[\u4E00-\u9FFF]/.test(c)) continue;
        sequence.push(`${c}1.JPEG`);
        if (strokeMap[c]) sequence.push(strokeMap[c]);
      }
      currentIndex = sequence.indexOf(`${char}1.JPEG`);
      if (currentIndex === -1) currentIndex = 0; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¾ç¬¬ä¸€å€‹é–‹å§‹
      
      // é¡¯ç¤ºå…¨è¢å¹•ä¸¦ç«‹å³é¡¯ç¤ºç•¶å‰åœ–ç‰‡
      fullscreenView.style.display = "flex";
      document.body.style.overflow = 'hidden';
      
      // é¡¯ç¤ºç•¶å‰åœ–ç‰‡ï¼ˆå¯èƒ½é‚„æ²’é è¼‰ï¼‰
      showCurrentImage();
      
      // é–‹å§‹é è¼‰æ‰€æœ‰åœ–ç‰‡ï¼ˆåœ¨èƒŒæ™¯é€²è¡Œï¼‰
      preloadAllImages();
    }

    function showCurrentImage() {
      if (currentIndex < 0 || currentIndex >= sequence.length) {
        closeFullscreen();
        return;
      }
      const imageCounter = document.getElementById("image-counter");
      imageCounter.textContent = `${currentIndex + 1} / ${sequence.length}`;
      
      const src = sequence[currentIndex];
      
      // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å·²ç¶“é è¼‰
      if (imageCache.has(src) && imageCache.get(src) !== null) {
        // åœ–ç‰‡å·²é è¼‰ï¼Œç›´æ¥é¡¯ç¤ºï¼ˆç„¡å»¶é²ï¼‰
        fullscreenImg.src = src;
        fullscreenImg.classList.remove('loading');
      } else {
        // åœ–ç‰‡æœªé è¼‰ï¼Œé¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ä¸¦è¼‰å…¥
        fullscreenImg.classList.add('loading');
        const img = new Image();
        img.onload = () => {
          imageCache.set(src, img);
          fullscreenImg.src = src;
          fullscreenImg.classList.remove('loading');
        };
        img.onerror = () => {
          imageCache.set(src, null);
          fullscreenImg.src = src; // å³ä½¿å¤±æ•—ä¹Ÿå˜—è©¦é¡¯ç¤º
          fullscreenImg.classList.remove('loading');
        };
        img.src = src;
      }
      
      // é è¼‰ç›¸é„°åœ–ç‰‡ï¼ˆä¸‹ä¸€å¼µå’Œä¸Šä¸€å¼µï¼‰ï¼Œè®“æ»‘å‹•æ›´é †æš¢
      if (currentIndex + 1 < sequence.length) {
        preloadImage(sequence[currentIndex + 1]).catch(() => {});
      }
      if (currentIndex - 1 >= 0) {
        preloadImage(sequence[currentIndex - 1]).catch(() => {});
      }
    }

    function closeFullscreen() {
      fullscreenView.style.display = "none";
      document.body.style.overflow = '';
    }

    // æ”¹é€²çš„è§¸æ§æ‰‹å‹¢è™•ç† - æ”¯æ´ iPad Safari
    let touchStartX = null;
    let touchStartY = null;
    let isSwiping = false;
    const SWIPE_THRESHOLD = 50; // æ»‘å‹•é–¾å€¼ï¼ˆåƒç´ ï¼‰

    fullscreenView.addEventListener('touchstart', handleTouchStart, { passive: true });
    fullscreenView.addEventListener('touchmove', handleTouchMove, { passive: false });
    fullscreenView.addEventListener('touchend', handleTouchEnd, { passive: true });
    // é»æ“Šé—œé–‰ï¼ˆéæ»‘å‹•æ™‚ï¼‰
    fullscreenView.addEventListener('click', (e) => {
      if (e.target === fullscreenView && !isSwiping) {
        closeFullscreen();
      }
    });

    function handleTouchStart(e) {
      const touch = e.touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      isSwiping = false;
    }

    function handleTouchMove(e) {
      if (touchStartX === null) return;
      const touch = e.touches[0];
      const deltaX = Math.abs(touch.clientX - touchStartX);
      const deltaY = Math.abs(touch.clientY - touchStartY);
      
      // å¦‚æœæ°´å¹³ç§»å‹•å¤§æ–¼å‚ç›´ç§»å‹•ï¼Œè¦–ç‚ºæ»‘å‹•
      if (deltaX > deltaY && deltaX > 10) {
        isSwiping = true;
        // é˜²æ­¢é é¢æ»¾å‹•
        e.preventDefault();
      }
    }

    function handleTouchEnd(e) {
      if (touchStartX === null || touchStartY === null) return;
      
      const touch = e.changedTouches[0];
      const deltaX = touch.clientX - touchStartX;
      const deltaY = touch.clientY - touchStartY;
      const absDeltaX = Math.abs(deltaX);
      const absDeltaY = Math.abs(deltaY);
      
      // åªæœ‰æ°´å¹³æ»‘å‹•è·é›¢å¤§æ–¼å‚ç›´è·é›¢ä¸”è¶…éé–¾å€¼æ™‚æ‰è™•ç†
      if (isSwiping && absDeltaX > absDeltaY && absDeltaX > SWIPE_THRESHOLD) {
        if (deltaX < 0) {
          // å‘å·¦æ»‘å‹• - ä¸‹ä¸€å¼µ
          currentIndex++;
          if (currentIndex >= sequence.length) {
            currentIndex = sequence.length - 1; // ä¿æŒåœ¨æœ€å¾Œä¸€å¼µ
          } else {
            showCurrentImage();
            // é è¼‰ä¸‹ä¸€å¼µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentIndex + 1 < sequence.length) {
              preloadImage(sequence[currentIndex + 1]).catch(() => {});
            }
          }
        } else {
          // å‘å³æ»‘å‹• - ä¸Šä¸€å¼µ
          currentIndex--;
          if (currentIndex < 0) {
            currentIndex = 0; // ä¿æŒåœ¨ç¬¬ä¸€å¼µ
          } else {
            showCurrentImage();
            // é è¼‰ä¸Šä¸€å¼µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentIndex - 1 >= 0) {
              preloadImage(sequence[currentIndex - 1]).catch(() => {});
            }
          }
        }
      }
      
      touchStartX = null;
      touchStartY = null;
      // å»¶é²é‡ç½® isSwipingï¼Œé¿å…è§¸ç™¼é»æ“Šäº‹ä»¶
      setTimeout(() => { isSwiping = false; }, 100);
    }

    // éµç›¤æ”¯æ´ï¼ˆæ¡Œé¢ç«¯ï¼‰
    document.addEventListener('keydown', (e) => {
      if (fullscreenView.style.display === 'flex') {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          currentIndex--;
          if (currentIndex < 0) currentIndex = 0;
          else {
            showCurrentImage();
            // é è¼‰ä¸Šä¸€å¼µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentIndex - 1 >= 0) {
              preloadImage(sequence[currentIndex - 1]).catch(() => {});
            }
          }
        } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          currentIndex++;
          if (currentIndex >= sequence.length) currentIndex = sequence.length - 1;
          else {
            showCurrentImage();
            // é è¼‰ä¸‹ä¸€å¼µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentIndex + 1 < sequence.length) {
              preloadImage(sequence[currentIndex + 1]).catch(() => {});
            }
          }
        } else if (e.key === 'Escape') {
          closeFullscreen();
        }
      }
    });
function playAudio() {
  const text = document.getElementById("sentence").innerText.trim();
  if (!text) return;

  if ('speechSynthesis' in window) {
    const synth = window.speechSynthesis;
    let voices = synth.getVoices();

    if (!voices.length) {
      synth.onvoiceschanged = () => playAudio(); // fallback for iPad
      return;
    }

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-TW';
    utterance.rate = 0.75;

    let zhVoices = voices.filter(v => v.lang === 'zh-TW');
    let preferred = zhVoices.find(v => v.name.includes("ç¾ä½³") || v.name.includes("Meijia"));
    if (!preferred && zhVoices.length > 0) {
      preferred = zhVoices[0];
    }
    if (preferred) {
      utterance.voice = preferred;
    }

    synth.cancel();
    synth.speak(utterance);
  } else {
    alert("æ­¤è£ç½®ä¸æ”¯æ´èªéŸ³æ’­æ”¾");
  }
}
    function nextSentence() {
      do {
        current = (current + 1) % sentences.length;
      } while (!sentences[current]);
      renderSentence();
    }

    function prevSentence() {
      do {
        current = (current - 1 + sentences.length) % sentences.length;
      } while (!sentences[current]);
      renderSentence();
    }

    function goToFirst() {
      current = 0;
      renderSentence();
    }

    loadSheet();
  </script>
</body>
</html>
